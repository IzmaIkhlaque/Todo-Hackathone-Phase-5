# Production deployment pipeline
# Triggers on push to main branch
# Stages: test -> build -> deploy -> verify
name: Deploy to Production

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  NAMESPACE: todo-chatbot

jobs:
  # Stage 1: Run tests
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Backend tests
        run: |
          cd backend
          pip install -r requirements.txt
          pytest tests/ -v

      - name: Frontend lint
        run: |
          cd frontend
          npm ci
          npm run lint

  # Stage 2: Build and push container images
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-backend:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-backend:latest \
            ./backend
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-backend --all-tags

      - name: Build and push frontend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-frontend:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-frontend:latest \
            ./frontend
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/todo-frontend --all-tags

  # Stage 3: Deploy to Kubernetes with Helm
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Set kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
          echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV

      - name: Deploy with Helm
        run: |
          helm upgrade --install todo-chatbot ./helm/todo-chatbot-chart \
            -f helm/todo-chatbot-chart/values-production.yaml \
            -n ${{ env.NAMESPACE }} --create-namespace \
            --set image.backend.tag=${{ github.sha }} \
            --set image.frontend.tag=${{ github.sha }} \
            --wait --timeout 5m

  # Stage 4: Verify deployment
  verify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Set kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > /tmp/kubeconfig
          echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV

      - name: Verify pods are running
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }}
          kubectl wait --for=condition=ready pod -l app=backend -n ${{ env.NAMESPACE }} --timeout=120s
          kubectl wait --for=condition=ready pod -l app=frontend -n ${{ env.NAMESPACE }} --timeout=120s

      - name: Verify services
        run: kubectl get svc -n ${{ env.NAMESPACE }}

      - name: Verify ingress
        run: kubectl get ingress -n ${{ env.NAMESPACE }}
